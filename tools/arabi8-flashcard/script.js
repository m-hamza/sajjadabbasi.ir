/* * دیتابیس کامل لغات عربی پایه هشتم (درس ۱ تا ۱۰)
 * استخراج شده از فایل‌های کتاب درسی
 */
const vocabData = [
    {
        lessonId: 1,
        title: "درس اول: مراجعة",
        words: [
            { ar: "بَسيط", fa: "ساده" }, { ar: "طَبّاخ", fa: "آشپز" }, { ar: "الثّامِن", fa: "هشتم" },
            { ar: "حافِلَة", fa: "اتوبوس" }, { ar: "طَبَخْتُ", fa: "پختم" }, { ar: "حَلْوانِيّ", fa: "شیرینی فروش" },
            { ar: "كُرَةُ الْقَدَمِ", fa: "فوتبال" }, { ar: "رُزّ", fa: "برنج" }, { ar: "مُراجَعَة", fa: "دوره کردن" },
            { ar: "رَسائِل", fa: "نامه‌ها (مفرد: رِسالَة)" }, { ar: "مُمَرِّض", fa: "پرستار" }, { ar: "زُمَلاء", fa: "هم‌کلاسی‌ها (مفرد: زَميل)" },
            { ar: "مَوْقِف", fa: "ایستگاه" }, { ar: "سَنَةٌ دِراسِيَّة", fa: "سال تحصیلی" }, { ar: "مُوَظَّف", fa: "کارمند" },
            { ar: "نَجَحَ", fa: "موفق شد" }, { ar: "شُرْطِيّ", fa: "مأمور پلیس" }, { ar: "نُصوص", fa: "متن‌ها (مفرد: نَصّ)" }
        ]
    },
    {
        lessonId: 2,
        title: "درس دوم: اهمیت زبان عربی",
        words: [
            { ar: "فارِغ", fa: "خالی" }, { ar: "أَسْعار", fa: "قیمت‌ها (مفرد: سِعْر)" }, { ar: "قَدَرَ", fa: "توانست" },
            { ar: "إيجار", fa: "کرایه، اجاره" }, { ar: "كَأَنَّ", fa: "گویا، انگار" }, { ar: "بِطاقَةُ الْهُويَّةِ", fa: "کارت شناسایی" },
            { ar: "كَتَمَ", fa: "پنهان کرد" }, { ar: "تَخْفيض", fa: "تخفیف" }, { ar: "كُلّ", fa: "همه، هر" },
            { ar: "لا بَأْسَ", fa: "اشکالی ندارد" }, { ar: "مُبين", fa: "آشکار" }, { ar: "تَعَلُّم", fa: "یاد گرفتن" },
            { ar: "جَعَلَ", fa: "قرار داد" }, { ar: "حَدّاد", fa: "آهنگر" }, { ar: "حَسَناً", fa: "خوب، بسیار خوب" },
            { ar: "مُحَدَّد", fa: "مشخص" }, { ar: "حَيّاكَ الله", fa: "زنده باشی" }, { ar: "مِصْعَد", fa: "آسانسور" },
            { ar: "الْخامِس", fa: "پنجم" }, { ar: "مُنَظَّمَة", fa: "سازمان" }, { ar: "خَبّاز", fa: "نانوا" },
            { ar: "ذاتُ ثَلاثَةِ أَسِرَّة", fa: "دارای سه تخت" }, { ar: "ساعَدَكَ اللهُ", fa: "خسته نباشی" }, { ar: "مَمْزوج", fa: "آمیخته" },
            { ar: "طابِق", fa: "طبقه" }, { ar: "مِنْ قِبَل", fa: "از طرف" }, { ar: "طَعام", fa: "غذا" },
            { ar: "نُريدُ", fa: "می‌خواهیم" }, { ar: "عالَم", fa: "جهان" }, { ar: "يُمْكِنُ", fa: "ممکن است" },
            { ar: "عِنْدَكُم", fa: "دارید، نزد شما" }
        ]
    },
    {
        lessonId: 3,
        title: "درس سوم: شغل آینده",
        words: [
            { ar: "آخَرين", fa: "دیگران" }, { ar: "صارَ", fa: "شد" }, { ar: "أَحَبَّ", fa: "دوست داشت" },
            { ar: "طِبُّ الْعُيون", fa: "چشم پزشکی" }, { ar: "عَمّ", fa: "عمو" }, { ar: "أُريدُ أَنْ أَذْهَبَ", fa: "می‌خواهم که بروم" },
            { ar: "عَنْ", fa: "درباره، از" }, { ar: "أَصْحابُ الْمِهَن", fa: "صاحبان شغل‌ها" }, { ar: "عَيْن", fa: "چشم، چشمه" },
            { ar: "أَنْصَحُكَ أَنْ تَذْهَبَ", fa: "تو را نصیحت می‌کنم که بروی" }, { ar: "فَحَصَ", fa: "معاینه کرد" }, { ar: "بِلاد", fa: "کشور، شهرها" },
            { ar: "قاطِع", fa: "برنده" }, { ar: "بَيْع", fa: "فروش" }, { ar: "لا أَدري", fa: "نمی‌دانم" },
            { ar: "تَقَدُّم", fa: "پیشرفت" }, { ar: "مَتى", fa: "چه وقت" }, { ar: "تَهيِئَة", fa: "تهیه" },
            { ar: "مَرْضى", fa: "بیماران" }, { ar: "خال", fa: "دایی" }, { ar: "مَرَّة", fa: "دفعه، بار" },
            { ar: "خَبَزَ", fa: "نان پخت" }, { ar: "مُسْتَقْبَل", fa: "آینده" }, { ar: "رِياضَة", fa: "ورزش" },
            { ar: "مِهْنَة", fa: "شغل" }, { ar: "نَصِلُ", fa: "می‌رسیم" }, { ar: "سَيَّارَةُ الْأُجْرَةِ", fa: "تاکسی" }
        ]
    },
    {
        lessonId: 4,
        title: "درس چهارم: تجربه جدید",
        words: [
            { ar: "غَرِقَ", fa: "غرق شد" }, { ar: "يَغْرَقُ", fa: "غرق می‌شود" }, { ar: "نَفْس", fa: "خود" },
            { ar: "طَيِّب", fa: "خوب، پاک" }, { ar: "اِبْن آدَم", fa: "آدمیزاد" }, { ar: "غَضَب", fa: "خشم" },
            { ar: "فَرَس", fa: "اسب" }, { ar: "فِضَّة", fa: "نقره" }, { ar: "فِعْل", fa: "کار، انجام دادن" },
            { ar: "قادِم", fa: "آینده" }, { ar: "قَصْد", fa: "منظور" }, { ar: "قَوْل", fa: "گفتار" },
            { ar: "كَذَبَ", fa: "دروغ گفت" }, { ar: "يَكْذِبُ", fa: "دروغ می‌گوید" }, { ar: "كَذٰلِكَ", fa: "همچنین" },
            { ar: "مُحِبّين", fa: "دوستداران" }, { ar: "أَمْشي", fa: "پیاده می‌روم، راه می‌روم" }, { ar: "إِنَّما", fa: "فقط" },
            { ar: "جَدَل", fa: "جر و بحث" }, { ar: "خَطايا", fa: "گناهان، خطاها" }, { ar: "شاهَدَ", fa: "دید" },
            { ar: "يُشاهِدُ", fa: "می‌بیند" }, { ar: "شَعْب", fa: "ملت" }, { ar: "شَكَرَ", fa: "تشکر کرد" },
            { ar: "يَشْكُرُ", fa: "تشکر می‌کند" }, { ar: "صَدَقَ", fa: "راست گفت" }, { ar: "يَصْدُقُ", fa: "راست می‌گوید" },
            { ar: "مُخْتَبَر", fa: "آزمایشگاه" }, { ar: "ضِيافَة", fa: "مهمانی" }, { ar: "مِضْياف", fa: "مهمان‌دوست" },
            { ar: "طُوبى لِـ", fa: "خوشا به حال" }, { ar: "نَفَعَ", fa: "سود رساند" }, { ar: "يَنْفَعُ", fa: "سود می‌رساند" },
            { ar: "عاشَ", fa: "زندگی کرد" }, { ar: "يَعيشُ", fa: "زندگی می‌کند" }
        ]
    },
    {
        lessonId: 5,
        title: "درس پنجم: دوستی",
        words: [
            { ar: "بِالتَّأكيد", fa: "البته" }, { ar: "جِئْتُم", fa: "آمدید" }, { ar: "أَبْصار", fa: "دیدگان (مفرد: بَصَر)" },
            { ar: "جَوْلَة", fa: "گردش" }, { ar: "حَبيب", fa: "دوست" }, { ar: "أَحْرار", fa: "آزادگان (مفرد: حُرّ)" },
            { ar: "حَرَسَ", fa: "نگهبانی داد" }, { ar: "يَحْرُسُ", fa: "نگهبانی می‌دهد" }, { ar: "خَزائِن", fa: "گنجینه‌ها" },
            { ar: "دَمْع", fa: "اشک" }, { ar: "أَتى", fa: "آمد" }, { ar: "يَأْتي", fa: "می‌آید" },
            { ar: "إِحْدى", fa: "یکی از (مؤنث)" }, { ar: "أَعْلَم", fa: "داناترین، داناتر" }, { ar: "أَنْفُسَهُم", fa: "خودشان را" },
            { ar: "ساحَة", fa: "حیاط، میدان" }, { ar: "بَعْدَما", fa: "پس از اینکه" }, { ar: "شَرِبَ", fa: "نوشید" },
            { ar: "يَشْرَبُ", fa: "می‌نوشد" }, { ar: "عُصْفور", fa: "گنجشک" }, { ar: "بَقِيَ", fa: "ماند" },
            { ar: "مِصْباح", fa: "چراغ" }, { ar: "بِكُلِّ سُرور", fa: "با کمال میل" }, { ar: "مَكْتوب", fa: "نوشته شده" },
            { ar: "تَصْريفُ النُّقود", fa: "تبدیل پول" }, { ar: "الثّالِث", fa: "سوم" }, { ar: "مُهِمَّةٌ إِدارِيَّة", fa: "مأموریت اداری" },
            { ar: "جار", fa: "همسایه" }
        ]
    },
    {
        lessonId: 6,
        title: "درس ششم: در سفر",
        words: [
            { ar: "قافِلَة", fa: "کاروان" }, { ar: "كُرَةُ الْمِنْضَدَةِ", fa: "تنیس روی میز" }, { ar: "أَرْبَعاً وَ ثَلاثين", fa: "سی و چهار" },
            { ar: "أَرْبَعون", fa: "چهل" }, { ar: "لِـ", fa: "دارد، برای" }, { ar: "أَمَرَ", fa: "دستور داد" },
            { ar: "يَأْمُرُ", fa: "دستور می‌دهد" }, { ar: "الأُولى", fa: "یکم، نخستین" }, { ar: "لا", fa: "نه (حرف نفی)" },
            { ar: "حُبوبٌ مُسَكِّنَة", fa: "قرص‌های مسکن" }, { ar: "ما بِكَ", fa: "تو را چه می‌شود؟" }, { ar: "خاتَم", fa: "انگشتر" },
            { ar: "مَرَضُ السُّكَّرِ", fa: "بیماری قند" }, { ar: "سافَرَ", fa: "سفر کرد" }, { ar: "يُسافِرُ", fa: "سفر می‌کند" },
            { ar: "مَساء", fa: "شب، بعد از ظهر" }, { ar: "سَفْرَة", fa: "سفر، گردش" }, { ar: "مُسْتَوْصَف", fa: "درمانگاه" },
            { ar: "مَعاً", fa: "با هم" }, { ar: "وَصْفَة", fa: "نسخه" }, { ar: "يَخْفى", fa: "پنهان می‌ماند" },
            { ar: "شَراب", fa: "شربت، نوشیدنی" }, { ar: "صُداع", fa: "سردرد" }, { ar: "ضَغْطُ الدَّمِ", fa: "فشار خون" },
            { ar: "طائِرَة", fa: "هواپیما" }
        ]
    },
    {
        lessonId: 7,
        title: "درس هفتم: زمین خدا وسیع است",
        words: [
            { ar: "ضَحِكَ", fa: "خندید" }, { ar: "يَضْحَكُ", fa: "می‌خندد" }, { ar: "طائِر", fa: "پرنده" },
            { ar: "عِنْدَما", fa: "وقتی که" }, { ar: "غابَة", fa: "جنگل" }, { ar: "غِزْلان", fa: "آهوها" },
            { ar: "فَرَح", fa: "شادی" }, { ar: "فَرْخ", fa: "جوجه" }, { ar: "آباء", fa: "پدران" },
            { ar: "إِضاعَة", fa: "تلف کردن" }, { ar: "أَلا", fa: "هان، آگاه باش" }, { ar: "جَلَبَ", fa: "آورد" },
            { ar: "يَجْلِبُ", fa: "می‌آورد" }, { ar: "حَطَب", fa: "هیزم" }, { ar: "حَمامَة", fa: "کبوتر" },
            { ar: "حَوائِج", fa: "نیازها" }, { ar: "كَما", fa: "همان‌طور که" }, { ar: "ذِئاب", fa: "گرگ‌ها" },
            { ar: "مُسْتَشْفى", fa: "بیمارستان" }, { ar: "الرّابِع", fa: "چهارم" }, { ar: "نَصْر", fa: "یاری" },
            { ar: "رَحِمَ اللَّهُ والِدَيْكَ", fa: "خدا پدر و مادرت را بیامرزد" }, { ar: "هَجَمَ", fa: "حمله کرد" }, { ar: "يَهْجُمُ", fa: "حمله می‌کند" },
            { ar: "صارَتْ عَلَيْكُم زَحْمَة", fa: "برایتان زحمت شد" }, { ar: "يَئِسَ", fa: "ناامید شد" }, { ar: "يَيْأَسُ", fa: "ناامید می‌شود" },
            { ar: "صَيْدَلِيَّة", fa: "داروخانه" }
        ]
    },
    {
        lessonId: 8,
        title: "درس هشتم: اعتماد به نفس",
        words: [
            { ar: "أَقْرِباء", fa: "خویشاوندان" }, { ar: "عُشّ", fa: "لانه" }, { ar: "تَسْأَلُ فِراخَها", fa: "از جوجه‌هایش می‌پرسد" },
            { ar: "قَمْح", fa: "گندم" }, { ar: "حَدَثَ", fa: "اتفاق افتاد" }, { ar: "يَحْدُثُ", fa: "اتفاق می‌افتد" },
            { ar: "كَوْكَب", fa: "ستاره" }, { ar: "حَضَرَ", fa: "حاضر شد" }, { ar: "يَحْضُرُ", fa: "حاضر می‌شود" },
            { ar: "مائِدَة", fa: "سفره غذا" }, { ar: "خَوْف", fa: "ترس" }, { ar: "نَهار", fa: "روز" },
            { ar: "ساجِد", fa: "سجده کننده" }, { ar: "يَعْتَمِدُ", fa: "اعتماد می‌کند، تکیه می‌کند" }, { ar: "عِزَّة", fa: "ارجمندی" },
            { ar: "الاعْتِمادُ عَلَى النَّفْسِ", fa: "تکیه به خود" }
        ]
    },
    {
        lessonId: 9,
        title: "درس نهم: سفر علمی",
        words: [
            { ar: "عَشاء", fa: "شام" }, { ar: "غَداء", fa: "ناهار" }, { ar: "أَزْهار", fa: "شکوفه‌ها، گل‌ها" },
            { ar: "غَفَرَ", fa: "آمرزید" }, { ar: "يَغْفِرُ", fa: "می‌آمرزد" }, { ar: "أَسْنان", fa: "دندان‌ها" },
            { ar: "فُرْشاة", fa: "مسواک" }, { ar: "الَّذينَ", fa: "کسانی که" }, { ar: "فِضِّيّ", fa: "نقره‌ای" },
            { ar: "أَوْلِياء", fa: "یاران" }, { ar: "فَطور", fa: "صبحانه" }, { ar: "بِمَ", fa: "با چه چیزی" },
            { ar: "مُحافَظَة", fa: "استان" }, { ar: "حُسْنى", fa: "نیکوتر، نیکو" }, { ar: "مَسْموح", fa: "مجاز" },
            { ar: "ذَنْب", fa: "گناه" }, { ar: "مَطْعَم", fa: "رستوران" }, { ar: "مَعْجونُ أَسْنان", fa: "خمیر دندان" },
            { ar: "السّابِع", fa: "هفتم" }, { ar: "السّادِس", fa: "ششم" }, { ar: "مَلْعَب", fa: "ورزشگاه" },
            { ar: "شاي", fa: "چای" }, { ar: "مِنْشَفَة", fa: "حوله" }, { ar: "شَلال", fa: "آبشار" }
        ]
    },
    {
        lessonId: 10,
        title: "درس دهم: مراقد دینی",
        words: [
            { ar: "التّاسِع", fa: "نهم" }, { ar: "الْحاديَ عَشَرَ", fa: "یازدهم" }, { ar: "تَمْر", fa: "خرما" },
            { ar: "الثّانيَ عَشَرَ", fa: "دوازدهم" }, { ar: "الْعاشِر", fa: "دهم" }
        ]
    }
];

/* * منطق برنامه و سیستم لایتنر 
 * --------------------------------
 */

// کلید ذخیره‌سازی در مرورگر
const DB_KEY = 'arabic_leitner_final_v2';

// فواصل زمانی جعبه لایتنر (روز)
const LEITNER_INTERVALS = [1, 2, 4, 8, 15]; 

let currentUser = null;
let currentSessionWords = [];
let currentCardIndex = 0;

document.addEventListener('DOMContentLoaded', () => {
    checkLogin();
});

// --- مدیریت کاربران ---

function checkLogin() {
    const storedData = localStorage.getItem(DB_KEY);
    if (storedData) {
        const data = JSON.parse(storedData);
        if (data.currentUser && data.users[data.currentUser]) {
            currentUser = data.users[data.currentUser];
            showDashboard();
            return;
        }
    }
    document.getElementById('login-section').classList.remove('hidden');
    document.getElementById('dashboard-section').classList.add('hidden');
    document.getElementById('study-section').classList.add('hidden');
}

function login() {
    const usernameInput = document.getElementById('username').value.trim();
    const passwordInput = document.getElementById('password').value.trim();

    if (!usernameInput) {
        alert("لطفا نام کاربری را وارد کنید");
        return;
    }

    let storedData = JSON.parse(localStorage.getItem(DB_KEY)) || { users: {}, currentUser: null };

    if (storedData.users[usernameInput]) {
        // کاربر وجود دارد
        if (storedData.users[usernameInput].password && storedData.users[usernameInput].password !== passwordInput) {
            alert("رمز عبور اشتباه است");
            return;
        }
    } else {
        // ایجاد کاربر جدید
        storedData.users[usernameInput] = {
            username: usernameInput,
            password: passwordInput,
            progress: {} // ساختار: { "لغت": { box: 1, nextReview: timestamp } }
        };
    }

    storedData.currentUser = usernameInput;
    localStorage.setItem(DB_KEY, JSON.stringify(storedData));
    currentUser = storedData.users[usernameInput];
    
    checkLogin();
}

function logout() {
    let storedData = JSON.parse(localStorage.getItem(DB_KEY));
    if (storedData) {
        storedData.currentUser = null;
        localStorage.setItem(DB_KEY, JSON.stringify(storedData));
    }
    location.reload();
}

// --- داشبورد و آمار ---

function showDashboard() {
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('study-section').classList.add('hidden');
    document.getElementById('dashboard-section').classList.remove('hidden');
    
    document.getElementById('display-name').textContent = currentUser.username;

    let totalWords = 0;
    let dueCount = 0;
    let mastered = 0;
    const now = Date.now();

    vocabData.forEach(lesson => {
        lesson.words.forEach(word => {
            totalWords++;
            const userWord = currentUser.progress[word.ar];
            
            if (!userWord) {
                dueCount++; // لغت جدید
            } else {
                if (userWord.box >= 6) {
                    mastered++;
                } else if (now >= userWord.nextReview) {
                    dueCount++;
                }
            }
        });
    });

    document.getElementById('due-count').textContent = dueCount;
    document.getElementById('mastered-words').textContent = mastered;
    
    let totalBoxes = 0;
    const maxScore = totalWords * 6;
    Object.values(currentUser.progress).forEach(p => totalBoxes += p.box);
    const percent = maxScore > 0 ? Math.round((totalBoxes / maxScore) * 100) : 0;
    document.getElementById('total-progress').textContent = percent + "%";

    // ساخت لیست درس‌ها
    const grid = document.getElementById('lessons-grid');
    grid.innerHTML = '';
    
    vocabData.forEach(lesson => {
        let lessonDue = 0;
        lesson.words.forEach(w => {
            const uw = currentUser.progress[w.ar];
            if (!uw || (uw.box < 6 && now >= uw.nextReview)) {
                lessonDue++;
            }
        });

        const div = document.createElement('div');
        div.className = 'lesson-card';
        div.innerHTML = `
            ${lessonDue > 0 ? `<span class="due-badge">${lessonDue} لغت مرور</span>` : ''}
            <h4>${lesson.title}</h4>
            <span>${lesson.words.length} لغت</span>
        `;
        div.onclick = () => startSession('lesson', lesson.lessonId);
        grid.appendChild(div);
    });
}

// --- مطالعه و لایتنر ---

function startGlobalReview() {
    startSession('global');
}

function startSession(mode, lessonId = null) {
    currentSessionWords = [];
    const now = Date.now();

    const processWord = (w) => {
        const uw = currentUser.progress[w.ar];
        if (!uw || (uw.box < 6 && now >= uw.nextReview)) {
            currentSessionWords.push(w);
        }
    };

    if (mode === 'global') {
        vocabData.forEach(l => l.words.forEach(processWord));
        document.getElementById('lesson-title').textContent = "مرور جامع لایتنر";
    } else {
        const lesson = vocabData.find(l => l.lessonId === lessonId);
        document.getElementById('lesson-title').textContent = lesson.title;
        lesson.words.forEach(processWord);
    }

    if (currentSessionWords.length === 0) {
        alert("تبریک! هیچ لغتی برای مرور باقی نمانده است.");
        return;
    }

    // تصادفی‌سازی کلمات
    currentSessionWords.sort(() => Math.random() - 0.5);

    currentCardIndex = 0;
    document.getElementById('dashboard-section').classList.add('hidden');
    document.getElementById('study-section').classList.remove('hidden');
    
    loadCard();
}

function loadCard() {
    const word = currentSessionWords[currentCardIndex];
    document.getElementById('progress-counter').textContent = `${currentCardIndex + 1} / ${currentSessionWords.length}`;
    
    const userWord = currentUser.progress[word.ar] || { box: 0 };
    const boxText = userWord.box === 0 ? "لغت جدید" : `خانه ${userWord.box}`;
    
    document.getElementById('box-badge').textContent = boxText;
    document.getElementById('card-front').textContent = word.ar;
    document.getElementById('card-back').textContent = word.fa;

    // ریست وضعیت کارت
    const flashcard = document.querySelector('.flashcard');
    const messageBox = document.getElementById('message-box');
    flashcard.classList.remove('flipped');
    messageBox.classList.add('hidden');
}

function flipCard() {
    document.querySelector('.flashcard').classList.toggle('flipped');
}

function handleAnswer(known) {
    const word = currentSessionWords[currentCardIndex];
    
    if (!currentUser.progress[word.ar]) {
        currentUser.progress[word.ar] = { box: 0, nextReview: 0 };
    }
    
    let userWord = currentUser.progress[word.ar];
    const messageBox = document.getElementById('message-box');
    
    // اگر کارت هنوز نچرخیده، بچرخان تا کاربر جواب را ببیند
    const flashcard = document.querySelector('.flashcard');
    if (!flashcard.classList.contains('flipped')) {
        flashcard.classList.add('flipped');
    }

    if (known) {
        // پاسخ صحیح: ارتقا به خانه بعد
        userWord.box++;
        if (userWord.box >= 6) {
            messageBox.textContent = "عالی! این لغت کاملاً حفظ شد.";
            messageBox.style.backgroundColor = "#ecfdf5";
            messageBox.style.color = "#047857";
            userWord.nextReview = 9999999999999; // تاریخ دور
        } else {
            const days = LEITNER_INTERVALS[userWord.box - 1];
            userWord.nextReview = Date.now() + (days * 24 * 60 * 60 * 1000);
            
            messageBox.textContent = `آفرین! رفت به خانه ${userWord.box}. مرور بعدی: ${days} روز دیگر.`;
            messageBox.style.backgroundColor = "#ecfdf5";
            messageBox.style.color = "#047857";
        }
    } else {
        // پاسخ غلط: بازگشت به خانه اول
        userWord.box = 1;
        userWord.nextReview = Date.now() + (1 * 24 * 60 * 60 * 1000); // فردا
        
        messageBox.textContent = "اشکال نداره. برگشت به خانه ۱. فردا مرور کن.";
        messageBox.style.backgroundColor = "#fef2f2";
        messageBox.style.color = "#991b1b";
    }

    messageBox.classList.remove('hidden');
    saveUserData();

    // رفتن به کارت بعد
    setTimeout(() => {
        currentCardIndex++;
        if (currentCardIndex < currentSessionWords.length) {
            loadCard();
        } else {
            alert("مرور تمام شد! خسته نباشید.");
            showDashboard();
        }
    }, 1500);
}

// --- ذخیره و پشتیبان‌گیری ---

function saveUserData() {
    let storedData = JSON.parse(localStorage.getItem(DB_KEY));
    storedData.users[currentUser.username] = currentUser;
    localStorage.setItem(DB_KEY, JSON.stringify(storedData));
}

function exportData() {
    const storedData = localStorage.getItem(DB_KEY);
    const blob = new Blob([storedData], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    const date = new Date().toISOString().slice(0,10);
    a.download = `backup_arabic_${date}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}